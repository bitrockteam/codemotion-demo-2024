<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bitrock - Codemotion 2024 Demo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://kit.fontawesome.com/93b990e741.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Muli"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
    <script src="https://unpkg.com/scrollreveal@4"></script>
    <!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>-->
    <script src="js/paho-mqtt-1.0.3-min.js" type="text/javascript"></script>


    <link rel="stylesheet" href="css/leaflet-sidebar.css"/>
    <link rel="stylesheet" href="css/main.css"/>

    <link rel="icon"
          type="image/png"
          href="img/favicon.png">
</head>

<body>
<div id="cookieconsent"></div>
<!-- optionally define the sidebar content via HTML markup -->
<div id="sidebar" class="leaflet-sidebar">

    <!-- nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <!-- top aligned tabs -->
        <ul role="tablist">
            <li><a href="#home" role="tab"><i class="fas fa-bars active"></i></a></li>
        </ul>

        <!-- bottom aligned tabs -->
        <ul role="tablist">
            <li><a href="#info" role="tab"><i class="fas fa-info-circle"></i></i></a></li>
        </ul>
    </div>

    <!-- panel content -->
    <div class="leaflet-sidebar-content" id="content">
        <div class="leaflet-sidebar-pane" id="home">

            <h1 class="leaflet-sidebar-header">
                Bitrock - Codemotion 2024 Demo
                <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
            </h1>

            <div class="reveal mb20">
                <h3>The Fleet Demo</h3>
                <p>In this demo, we simulate hundreds of trucks driving around Italy, you can see fifteen of them
                    on the map.</p>
                <p>To follow one truck in its route, just click on its label. Sending MQTT messages
                    to the Waterstream, each truck continuously communicates its current position, the next way-point
                    and
                    the speed.</p>
            </div>
            <div class="reveal mb20">
                <h3>Query with LLM</h3>
                <p>Ask something to our LLM query service:</p>
                <form id="queryForm">
                    <textarea id="queryText"
                              style="font-family: 'Muli', sans-serif; width: 94%; height: 100px; resize: vertical; font-size: 18px;"
                              onclick="this.focus();"></textarea><br><br>
                    <button id="submitQueryButton" type="button"
                            style="font-family: 'Muli', sans-serif; font-size: 14px;" onclick="sendQuerySql()">Ask LLM + SQL RAG
                    </button>
                </form>
                <br>
                <div id="querySqlResponse" class="mr15" style="font-family: 'Muli', sans-serif; font-size: 18px; min-height: 100px; max-height: 300px; overflow:auto; border: 1px solid #aaa; padding: 6px;"></div>
                <br>
                <button id="submitDocRagQueryButton" type="button"
                        style="font-family: 'Muli', sans-serif; font-size: 14px;" onclick="sendQueryDocument()">Enhance with Document RAG
                </button>
                <br>
                <br>
                <div id="queryDocResponse" class="mr15" style="font-family: 'Muli', sans-serif; font-size: 18px; min-height: 100px; max-height: 300px; overflow:auto; border: 1px solid #aaa; padding: 6px;"></div>
            </div>
            <div class="reveal mb20">
                <h3>Fleet directions statistics</h3>
                <p>Hence MQTT messages are stored directly in Kafka, you can aggregate them with any streaming
                    technology.</p>
                <p>Below we built a real time graph that shows where trucks are headed using current position and
                    waypoint. Graph data is processed by a Flink job that aggregates MQTT messages saved on a Kafka
                    topic.
                </p>
            </div>
            <div class="reveal mb20">
                <canvas id="vehiclesStats" width="380" height="250"></canvas>
            </div>
        </div>
        <div class="leaflet-sidebar-pane " id="info">
            <h1 class="leaflet-sidebar-header">
                Info
                <span class="leaflet-sidebar-close"><i class="fas fa-info-circle"></i></span>
            </h1>
            <p> Want to know more about Bitrock? Check out <a href="https://bitrock.it">https://bitrock.it</a>.
            </p>
        </div>
    </div>
</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
        integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
        crossorigin=""></script>
<script src="../js/leaflet-sidebar.js"></script>

<script src="https://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/vertx/3.8.3/vertx-eventbus.min.js"></script>-->

<script>
    var exports = {}; // workaround, see DrifMarker sample


</script>

<script src="https://unpkg.com/leaflet-drift-marker@1.0.3/lib/DriftMarker/Drift_Marker.js"></script>

<script>
    // standard leaflet map setup
    let map = L.map('map');
    map.setView([41.9102415, 12.395915], 6);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={token}', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        token: "[[${mapboxToken}]]"
    }).addTo(map);

    // create the sidebar instance and add it to the map
    const sidebar = L.control.sidebar({container: 'sidebar'})
        .addTo(map)
        .open('home');

    // be notified when a panel is opened
    sidebar.on('content', function (ev) {
        switch (ev.id) {
            case 'autopan':
                sidebar.options.autopan = true;
                break;
            default:
                sidebar.options.autopan = false;
        }
    });

    const vehiclesStatsChart = new Chart("vehiclesStats", {
        type: 'doughnut',
        data: {
            labels: ['NE', 'SE', 'SW', 'NW'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    '#FDC187FF',
                    '#EB6400FF',
                    '#FB8F2DFF',
                    '#933400FF'
                ],
                borderColor: [
                    '#FFFFFFFF',
                    '#FFFFFFFF',
                    '#FFFFFFFF',
                    '#FFFFFFFF'
                ],
                borderWidth: 3
            }]
        },
        options: {
            title: {
                display: true,
                text: "Vehicles by Directions"
            },
            plugins: {
                labels: {
                    fontColor: '#fff',
                    render: "value"
                }
            }
        }
    });

    const statsKeyIndex = {
        "NE": 0,
        "SE": 1,
        "SW": 2,
        "NW": 3
    }

    function updateVehicleStats(key, vehicles) {
        const i = statsKeyIndex[key]
        if (isNaN(i)) {
            console.warn("Unknown key", key)
        } else {
            vehiclesStatsChart.data.datasets[0].data[i] = vehicles
            vehiclesStatsChart.update()
        }
    }

    let registry = new Map()

    let plateToFollow = null

    function addMarker(vehicle) {
        console.log("Add marker", vehicle.plate);
        var follow = vehicle.follow;

        let marker = new Drift_Marker([vehicle.current.lat, vehicle.current.lng], {
            draggable: false,
            title: 'Truck: ' + vehicle.plate,
            alt: 'Truck: ' + vehicle.plate,
            riseOnHover: true,
            keepAtCenter: follow
        })
            .addTo(map)
            .bindPopup("Truck " + vehicle.plate + '<br />' + 'Speed: ' + Math.trunc(vehicle.speed) + ' km/h');

        if (plateToFollow == null) {
            plateToFollow = vehicle.plate
        }

        if (plateToFollow == vehicle.plate) {
            console.log("This is the truck to follow ", vehicle.plate);
            marker.openPopup();
            map.setView([vehicle.current.lat, vehicle.current.lng], 14);
        } else {
            console.debug("Other vehicle is followed instead of this", plateToFollow, vehicle.plate)
        }

        registry.set(vehicle.plate, marker);
    }

    function cleanMarkers() {
        let markers = Array.from(registry.values());
        markers.forEach(function (m) {
            map.removeLayer(m);
        });
        registry = new Map()
    }


    function plateFromMqttTopic(topic) {
        const lastSlash = topic.lastIndexOf("/")
        if (lastSlash <= 0)
            return topic
        else
            return topic.slice(lastSlash)
    }

    const mqttClientId = "[[${mqttClientPrefix}]]" + Math.floor(Math.random() * 1000000)
    const mqttClient = new Paho.MQTT.Client("[[${mqttHost}]]", [[${mqttPort}]], "/mqtt", mqttClientId);

    function connectMqtt() {
        console.debug("connecting MQTT client..")
        mqttClient.connect({
            useSSL: [[${mqttUseSsl}]],
            cleanSession: true,
            mqttVersion: 4,
            onSuccess: function () {
                console.debug("MQTT client connected", mqttClientId)
                mqttClient.subscribe("[[${mqttVehiclesTopicPrefix}]]#")
                mqttClient.subscribe("[[${mqttDirectionStatsTopicPrefix}]]#")
                console.debug("Subscribed for MQTT topics")
            }
        })
    }

    mqttClient.onConnectionLost = function () {
        console.warn("MQTT connection lost, reconnecting in 5 seconds...", mqttClientId)
        cleanMarkers()
        setTimeout(connectMqtt, 5000)
    }
    mqttClient.onMessageArrived = function (message) {
        if (message.destinationName.startsWith("[[${mqttVehiclesTopicPrefix}]]")) {
            //vehicle changes message
            if (message.payloadString.length == 0) {
                //vehicle deleted
                const plate = plateFromMqttTopic(message.destinationName)
                console.debug("vehicle deleted", message.destinationName, plate)
                const marker = registry.get(plate);
                map.removeLayer(marker);
                registry.delete(plate);
            } else {
                //vehicle moved/created
                try {
                    const vehicle = JSON.parse(message.payloadString)
                    // console.debug("vehicle moved", message.destinationName, vehicle)
                    let marker = registry.get(vehicle.plate);
                    if (marker == null) {
                        addMarker(vehicle)
                    }
                    marker = registry.get(vehicle.plate);
                    marker.setLatLng(L.latLng(vehicle.current.lat, vehicle.current.lng));
                    marker.setPopupContent(`Truck <a style="cursor: pointer; color: blue; text-decoration: underline;"onclick="handlePopupClick('${vehicle.plate}')">` + vehicle.plate + '</a><br />' + 'Speed: ' + Math.trunc(vehicle.speed) + ' km/h');
                } catch (e) {
                    console.warn("Failed to create/update vehicle", e)
                }
            }
        } else if (message.destinationName.startsWith("[[${mqttDirectionStatsTopicPrefix}]]")) {
            const stats = JSON.parse(message.payloadString)
            console.debug("statistics received", stats)
            updateVehicleStats(stats.direction, stats.vehicles_count)
        }
    }

    connectMqtt()


</script>

<script>
    ScrollReveal().reveal('#content .reveal', {
        container: '#content',
        origin: 'top',
        scale: 0.6,
        duration: 1500,
        delay: 50
    })
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    function handlePopupClick(plate) {
        document.getElementById('queryText').value = `Show all information about truck with plate ${plate}`;
        sendQuerySql();
    }
</script>

<script>
    function sendQuerySql() {
        const messageContent = document.getElementById('queryText').value;

        if (messageContent.length > 0) {
            const submitQueryButton = document.getElementById('submitQueryButton');
            const submitDocRagQueryButton = document.getElementById('submitDocRagQueryButton');
            submitQueryButton.disabled = true;
            submitDocRagQueryButton.disabled = true;
            document.getElementById('querySqlResponse').innerHTML = 'Processing...';
            document.getElementById('queryDocResponse').innerHTML = '';
            fetch("[[${querySQLServiceUrl}]]", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({query: messageContent})
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('querySqlResponse').innerHTML = marked.parse(data.text);
                })
                .catch((error) => {
                    document.getElementById('querySqlResponse').innerHTML = 'Error while processing response';
                })
                .finally(() => {
                    submitQueryButton.disabled = false;
                    submitDocRagQueryButton.disabled = false;
                });
        }
    }

    function sendQueryDocument() {
        const messageContent = document.getElementById('querySqlResponse').innerHTML;

        if (messageContent.length > 0) {
            const submitQueryButton = document.getElementById('submitQueryButton');
            const submitDocRagQueryButton = document.getElementById('submitDocRagQueryButton');
            submitQueryButton.disabled = true;
            submitDocRagQueryButton.disabled = true;
            document.getElementById('queryDocResponse').innerHTML = 'Processing...';
            fetch("[[${queryDocumentServiceUrl}]]", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({query: messageContent})
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('queryDocResponse').innerHTML = marked.parse(data.text);
                })
                .catch((error) => {
                    document.getElementById('queryDocResponse').innerHTML = 'Error while processing response';
                })
                .finally(() => {
                    submitQueryButton.disabled = false;
                    submitDocRagQueryButton.disabled = false;
                });
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
<script>
    window.cookieconsent.initialise({
        container: document.getElementById("cookieconsent"),
        palette: {
            popup: {background: "#FB8F2D"},
            button: {background: "#EB6400"},
        },
        revokable: false,
        onStatusChange: function (status) {
            console.log(this.hasConsented() ?
                'enable cookies' : 'disable cookies');
        },
        "position": "bottom-right",
        "theme": "classic",
        "domain": "https://codemotion2024.bitrock.it/",
        "secure": true,
        "content": {
            "header": 'Cookies used on the website!',
            "message": 'This website uses cookies to improve your experience.',
            "dismiss": 'Got it!',
            "allow": 'Allow cookies',
            "deny": 'Decline',
            "link": 'Learn more',
            "href": '',
            "close": '&#x274c;',
            "policy": 'Cookie Policy',
            "target": '_blank',
        }
    });


</script>
</body>
</html>